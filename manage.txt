const minValues=[23,28,33],yinYangMax=297,energyMax=198;let savedDay=null,alertShown=!1;function saveDateFromFirstForm(){const e=document.getElementById("day").value,t=document.getElementById("month").value,a=document.getElementById("year").value;e&&t&&a&&(savedDay=parseInt(e,10),savedMonth=parseInt(t,10),savedYear=parseInt(a,10))}function calculateRanges(e,t,a){const{markers:n,yearMarkers:l}=getMarkersForYearAndMonth(a,t),i=getDaysInMonth(a,t)-e,o=l.map(((e,t)=>{let a=e+n[t]+i;for(;a>=minValues[t];)a-=minValues[t];return 0===a&&(a=minValues[t]),a}));return{physical:physicalContour[o[0]-1],emotional:emotionalContour[o[1]-1],intelligence:intelligenceContour[o[2]-1]}}function applyRangesToGlobalState(e){Object.entries(e).forEach((([e,{range:t}])=>{window[`${e}Range1`]=t[0],window[`${e}Range2`]=t[1]}))}function processUserData(e,t,a){const n=calculateTypology(e,t,a),l=TYPOLOGY_MEANINGS[n].meaning,i=calculateRanges(e,t,a);applyRangesToGlobalState(i),updateElements({typology:`${n} - ${l}`,quote:TYPOLOGY_MEANINGS[n].quote,typologyTitle:`${n} - ${l}`,typologyDetailed:TYPOLOGY_MEANINGS[n].detailed}),showUserAge(e,t,a),calculateChakraAnalysis(),calculateEnergyBalance(sliderState.isRightHanded),personaltyContour(i),energyPower(),observeProgressBarUpdate(),calculateLifeTask(e,t,a),calculateLifeCycleData(e,t,a,n)}function calculateChakraAnalysis(){updateElements({ajna:`${intelligenceRange2} %`,vishudha:`${intelligenceRange1} %`,anahata:`${emotionalRange2} %`,manipura:`${emotionalRange1} %`,svadhisthana:`${physicalRange2} %`,muladhara:`${physicalRange1} %`,ajnaTitle:getChakraDescription("ajna",intelligenceRange2).title,ajnaDetailed:getChakraDescription("ajna",intelligenceRange2).detailed,vishudhaTitle:getChakraDescription("vishudha",intelligenceRange1).title,vishudhaDetailed:getChakraDescription("vishudha",intelligenceRange1).detailed,anahataTitle:getChakraDescription("anahata",emotionalRange2).title,anahataDetailed:getChakraDescription("anahata",emotionalRange2).detailed,manipuraTitle:getChakraDescription("manipura",emotionalRange1).title,manipuraDetailed:getChakraDescription("manipura",emotionalRange1).detailed,svadhistanaTitle:getChakraDescription("svadhisthana",physicalRange2).title,svadhistanaDetailed:getChakraDescription("svadhisthana",physicalRange2).detailed,muladharaTitle:getChakraDescription("muladhara",physicalRange1).title,muladharaDetailed:getChakraDescription("muladhara",physicalRange1).detailed})}function calculateEnergyBalance(e){const t=calculateRange(physicalRange2,emotionalRange2,intelligenceRange2,yinYangMax),a=calculateRange(physicalRange1,emotionalRange1,intelligenceRange1,yinYangMax),n=calculateRange(intelligenceRange2,intelligenceRange1,emotionalRange1,yinYangMax),l=calculateRange(intelligenceRange2,intelligenceRange1,emotionalRange2,yinYangMax);updateElements({yin:`${t} %`,yang:`${a} %`,logic:e?`${n} %`:`${l} %`,intuition:e?`${l} %`:`${n} %`})}function personaltyContour(e){updateElements({physicalType:e.physical.type,emotionalType:e.emotional.type,intelligenceType:e.intelligence.type,physicalTitle:e.physical.type,emotionalTitle:e.emotional.type,intelligenceTitle:e.intelligence.type,physicalDetailed:e.physical.detailed,emotionalDetailed:e.emotional.detailed,intelligenceDetailed:e.intelligence.detailed})}function calculateLifeTask(e,t,a){const n=calculateTypology(e,t,a),l=calculateFamilyTask(e,t),i=l+n,o=calculatePast(e,t,a),c=Math.floor(o/Math.pow(10,Math.floor(Math.log10(o)))),r=c+o%10;lifePeriods(o,n),updateElements({"lineage-1":calculateSumAndReduce(l),"lineage-2":calculateSumAndReduce(i),"parent-1":calculateSumAndReduce(r+l,!0),"parent-2":calculateSumAndReduce(calculateSumAndReduce(r+l,!0)+n),"present-1":calculateSumAndReduce(r),"present-2":reduceToSingleDigit(calculateTypology(e,t,a)+r),"past-1":c,"past-2":calculateSumAndReduce(c+calculateTypology(e,t,a)),lineageTitle:`Задача рода - ${calculateSumAndReduce(l)}`,parentTitle:`Задача родителя - ${calculateSumAndReduce(r+l,!0)}`,currentTitle:`Задача настоящего - ${calculateSumAndReduce(r)}`,pastTitle:`Задача прошлого - ${c}`,lineagePositive:LINEAGE_DETAILED[calculateSumAndReduce(l)].positive,lineageNegative:LINEAGE_DETAILED[calculateSumAndReduce(l)].negative,parentDetailed:PARENT_DETAILED[calculateSumAndReduce(r+l,!0)].detailed,currentDetailed:CURRENT_DETAILED[calculateSumAndReduce(r)].detailed,pastDetailed:PAST_DETAILED[c].detailed})}function lifePeriods(e,t){let a=e.toString().substring(1);const n=sumDigits(e,t);6===e.toString().substring(1).length?showLastColumn():hideLastColumn(),fillTable([a,n])}function sumDigits(e,t,a=1){return e.toString().substring(a).split("").map((e=>{let a=parseInt(e)+t;for(;a>9;)a=a.toString().split("").reduce(((e,t)=>e+parseInt(t)),0);return a.toString()})).join("")}function fillTable(e){e.forEach(((e,t)=>{e.split("").forEach(((e,a)=>{const n=document.getElementById(`row${t+1}-cell${a+1}`);n&&(n.textContent=e)}))}))}function hideLastColumn(){updateAgeRanges("15 лет","15-30 лет","30-45 лет","45-60 лет","> 60 лет"),document.getElementById("hideIfEmpty").style.display="none"}function showLastColumn(){updateAgeRanges("12 лет","12-24 лет","24-36 лет","36-48 лет","48-60 лет"),document.getElementById("hideIfEmpty").style.display="inline"}function updateAgeRanges(e,t,a,n,l){updateElements({ageRange1:e,ageRange2:t,ageRange3:a,ageRange4:n,ageRange5:l})}function energyPower(){const e=Math.abs(physicalRange2+emotionalRange2+intelligenceRange2-(physicalRange1+emotionalRange1+intelligenceRange1)),t=Math.abs(physicalRange1);updateElements({wantTo:e,canDo:t,livePotential:Math.abs(e*t)})}function showUserAge(e,t,a){updateElements({"user-full-age":`${e} ${MONTHS[t-1]} ${a}`,"user-age":calculateUserAge(e,t,a),"user-sex":sliderState.isFemale?"Женский":"Мужской"})}function getChakraDescription(e,t,a=CHAKRA_DETAILED){const n=a[e];if(!n)throw new Error(`Чакра "${e}" не найдена.`);for(const e in n){const[a,l]=e.split("-").map(Number);if(t>=a&&t<=l)return{title:n[e][0],detailed:n[e][1]}}return`Значение ${t} не попадает ни в один диапазон для чакры "${e}".`}function getAgeLabel(e){const t=e%10,a=e%100;return a>=11&&a<=14?"лет":1===t?"год":t>=2&&t<=4?"года":"лет"}function calculateUserAge(e,t,a){const n=new Date(a,t-1,e),l=new Date-n,i=new Date(l).getUTCFullYear()-1970;return`${i} ${getAgeLabel(i)}`}function calculateSumAndReduce(e){return reduceToSingleDigit(e.toString().split("").reduce(((e,t)=>e+Number(t)),0))}function reduceToSingleDigit(e){for(;e>9;)e=`${e}`.split("").reduce(((e,t)=>e+ +t),0);return e}function calculateTypology(e,t,a){return calculateSumAndReduce(`${e}${t}${a}`)}document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelectorAll('#user-date input[type="number"]'),t=document.querySelector("#user-date").querySelector(".calculate-btn");function a(e){e?(t.classList.add("loading"),t.disabled=!0,t.textContent="Загрузка..."):(t.classList.remove("loading"),t.disabled=!1,t.textContent="Рассчитать")}day&&month&&year?(e.forEach((e=>{e.addEventListener("input",(()=>{if(e.value=e.value.replace(/[^0-9]/g,""),"day"===e.id||"month"===e.id){e.value=e.value.replace(/^0+/,"0"),e.value.length>2&&(e.value=e.value.slice(0,2));const t=parseInt(e.value,10);if("day"===e.id&&(t>31||t<0)?e.value="31":"month"===e.id&&(t>12||t<0)&&(e.value="12"),2===e.value.length){const t="day"===e.id?document.getElementById("month"):"month"===e.id?document.getElementById("year"):null;t&&t.focus()}}if("year"===e.id&&e.value.length>=4){const t=parseInt(e.value,10);t<1900?e.value="1900":t>2099&&(e.value="2099")}})),e.addEventListener("blur",(()=>{const e=document.getElementById("day").value,t=document.getElementById("month").value,a=document.getElementById("year").value,n=parseInt(e,10),l=parseInt(t,10),i=parseInt(a,10);if(e&&t&&a&&!function(e,t,a){const n=new Date(a,t-1,e);return n.getDate()===e&&n.getMonth()===t-1&&n.getFullYear()===a}(n,l,i)){const e=function(e,t,a){const n=new Date(a,t,0).getDate();return e>n?n:e}(n,l,i);document.getElementById("day").value=e,alertShown||(showToast({title:"В этом месяце дней меньше введённого",message:`День изменен на ${e}`}),alertShown=!0)}saveDateFromFirstForm()}))})),t.addEventListener("click",(e=>{e.preventDefault();const t=document.getElementById("day").value,n=document.getElementById("month").value,l=document.getElementById("year").value;t&&n&&l?(a(!0),setTimeout((()=>{const e=parseInt(t,10),i=parseInt(n,10),o=parseInt(l,10);if(e<1||e>31||i<1||i>12||o<1900||o>2099)return showToast({title:"Неверная дата",message:"Пожалуйста, введите корректную дату"}),void a(!1);closeAllSections(),processUserData(e,i,o),a(!1)}),200)):showToast({title:"Поля не заполнены",message:"Заполните, пожалуйста, все поля"})}))):showToast({title:"Поля не заполнены",message:"Заполните, пожалуйста, все поля"})})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".form"),t=e.querySelector('input[placeholder="Месяц"]'),a=e.querySelector('input[placeholder="Год"]'),n=e.querySelector(".calculate-btn");function l(e){e?(n.classList.add("loading"),n.disabled=!0,n.textContent="Загрузка..."):(n.classList.remove("loading"),n.disabled=!1,n.textContent="Рассчитать")}function i(e){const t=parseInt(e,10);return t<1?"1":t>12?"12":t.toString()}t.addEventListener("input",(()=>{t.value=t.value.replace(/[^0-9]/g,""),t.value=t.value.replace(/^0+/,"0"),t.value.length>2&&(t.value=t.value.slice(0,2)),2===t.value.length&&(t.value=i(t.value),a.focus())})),a.addEventListener("input",(()=>{a.value=a.value.replace(/[^0-9]/g,""),a.value.length>4&&(a.value=a.value.slice(0,4))})),t.addEventListener("blur",(()=>{t.value&&(t.value=i(t.value))})),a.addEventListener("blur",(()=>{a.value&&(a.value=function(e){const t=parseInt(e,10);return t<1900?"1900":t>2099?"2099":t.toString()}(a.value))})),n.addEventListener("click",(async e=>{e.preventDefault();const n=t.value,i=a.value;if(!n||!i)return void showToast({title:"Поля пропущены",message:"Пожалуйста, заполните, оба поля: месяц и год"});const o=parseInt(n,10),c=parseInt(i,10);if(o<1||o>12||c<1900||c>2099)showToast({title:"Неверные данные",message:"Проверьте, что все поля заполнены верно"});else{l(!0);try{if(await new Promise((e=>setTimeout(e,200))),null!==savedDay&&null!==savedMonth&&null!==savedYear){const e=calculateTypology(savedDay,savedMonth,savedYear);calculateLifeCycleData(savedDay,savedMonth,savedYear,e,o,c)}else showToast({title:"Первая форма не заполнена",message:"Пожалуйста, заполните первую форму"})}catch(e){showToast({title:"Ошибка",message:"Произошла ошибка при обработке данных"})}finally{l(!1)}}}))})),document.addEventListener("DOMContentLoaded",(()=>{const e=new Date,t=e.getMonth()+1,a=e.getFullYear();document.getElementById("chosenMonth").value=t,document.getElementById("chosenYear").value=a}));const checkLeapYear=e=>e%4==0&&e%100!=0||e%400==0,getDaysInMonth=(e,t)=>{const a=checkLeapYear(e),n=MONTH_MARKERS.find((e=>e.month===t));return 2===t&&a?29:n.days},getMarkersForYearAndMonth=(e,t)=>{const a=checkLeapYear(e),n=MONTH_MARKERS.find((e=>e.month===t)),l=YEAR_MARKERS.find((t=>t.year===e)).values;return{markers:a?n.leap:n.normal,yearMarkers:l}};function calculateFamilyTask(e,t){return calculateSumAndReduce(`${e}${t}`)}function calculatePast(e,t,a){return parseInt(`${e.toString().padStart(2,"0")}${t.toString().padStart(2,"0")}`,10)*a}function calculateRange(e,t,a,n){return Math.round((e+t+a)/n*100)}function observeProgressBarUpdate(){const e=document.querySelector(".chart");if(!e)return;new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(updateEnergyResults(),t.unobserve(e.target))}))}),{threshold:.5}).observe(e)}function updateEnergyResults(){const e={physicalEnergy:[physicalRange1,physicalRange2,0],emotionalEnergy:[emotionalRange1,emotionalRange2,0],intelligenceEnergy:[intelligenceRange1,intelligenceRange2,0]},t=Object.fromEntries(Object.entries(e).map((([e,t])=>[e,calculateRange(...t,energyMax)]))),a={physicalEnergy:document.querySelector(".bar.pinky-sand"),emotionalEnergy:document.querySelector(".bar.mild-aquamarine"),intelligenceEnergy:document.querySelector(".bar.ice-cold")};Object.entries(t).forEach((([e,t])=>{a[e].style.width=`${t}%`})),updateElements(t,a,"%")}function updateElements(e,t={},a=""){Object.entries(e).forEach((([e,n])=>{const l=document.getElementById(e);n||console.log(e,n),l&&(l.textContent=`${n}${a}`);const i=t[e];i&&(i.style.width=`${n}${a}`)}))}function calculateLifeCycleData(e,t,a,n,l=null,i=null){const o=new Date,c=o.getFullYear(),r=o.getMonth()+1,s=l||r,u=i||c,d=calculatePast(e,t,a),g=convertToPairs(d,sumDigits(d,n,0)),m=g.length,y=extendToTargetLength(d*u,12),h=convertToPairs(y,sumDigits(y,n,0)),p=extendToTargetLength(d*u*s,getDaysInMonth(u,s)),f=convertToPairs(p,sumDigits(p,n,0)),v=findMostFrequent(h),E=findMostFrequent(f);fillTableWithYearResults(a,m,g,u),fillAccordion(index=findArrayIndexByYear(g,a,u)),fillTableWithMonthResults(h,v.indices),fillTableWithDayResults(f,E.indices)}function findMostFrequent(e){const t={};e.forEach((e=>{t[e]=(t[e]||0)+1}));let a=null,n=0;for(const e in t)t[e]>n&&(a=e,n=t[e]);const l=[];return e.forEach(((e,t)=>{e===a&&l.push(t)})),{element:a,count:n,indices:l}}function fillTableWithMonthResults(e,t){document.getElementById("monthly-table").querySelectorAll(".table__column .table__cell:not(.cell-background)").forEach(((a,n)=>{a.querySelector("p").textContent=e[n],t.includes(n)?a.style.backgroundColor="rgb(25 135 84 / 50%)":a.style.backgroundColor="rgb(42 41 44)"}))}function fillTableWithDayResults(e,t){const a=document.getElementById("daily-table").querySelectorAll(".table__column .table__cell:not(.cell-background)");index=0,a.forEach((a=>{const n=a.querySelector("p");index<e.length?(n.textContent=e[index],t.includes(index)?a.style.backgroundColor="rgb(25 135 84 / 50%)":a.style.backgroundColor="rgb(42 41 44)",index++):(a.style.backgroundColor="rgb(42 41 44)",n.textContent="-")}))}function convertToPairs(e,t){const a=e.toString(),n=t.toString();if(a.length!==n.length)throw new Error("Числа должны быть одинаковой длины");const l=[];for(let e=0;e<a.length;e++)l.push(`${a[e]}/${n[e]}`);return l}function extendToTargetLength(e,t){let a=e.toString();if(t<=a.length)return a;for(;a.length<t;)a+=a.slice(0,t-a.length);return a}function createCell(e,t="",a=null){const n=document.createElement("div");n.className=`table__cell ${t}`,e===a&&(n.style.backgroundColor="rgb(25 135 84 / 50%)");const l=document.createElement("p");return l.className="calc-label",l.textContent=e,n.appendChild(l),n}function createColumn(e,t,a=null,n=null){const l=document.createElement("div");l.className="table__column";for(let i=0;i<t;i++){let o=e[i],c=i<t-1?"border-bottom":"";a&&0===i&&(o=a,c=`cell-background ${c}`),l.appendChild(createCell(o,c,n))}return l}function fillTableWithYearResults(e,t,a,n=2025){const l=document.getElementById("table-content"),i=document.getElementById("collapsible-part");l.innerHTML="",i.innerHTML="";for(let i=0;i<t;i++){const o=Array.from({length:2},((a,n)=>e+i+n*t));l.appendChild(createColumn([a[i]||"",...o],3,a[i],n))}for(let a=0;a<t;a++){const l=Array.from({length:7},((n,l)=>e+2*t+a+l*t));i.appendChild(createColumn(l,7,null,n))}}function findArrayIndexByYear(e,t,a){let n=0;for(let l=0;l<Math.abs(t-a);l++)n++,n===e.length&&(n=0);return t>a&&(n=-n),e.at(n)[0]}function fillAccordion(e){const t=YEAR_ENERGY_DETAILED[e];updateElements({yearEnergyTitleAdvantages:`${t.title} плюсе`,yearEnergyAdvantages:t.advantages,yearEnergyTitleDisadvantages:`${t.title} минусе`,yearEnergyDisadvantages:t.disadvantages})}function checkEmptyVariables(e){for(const[t,a]of Object.entries(e))a||console.log(`Переменная ${t} пуста Дата - ${date}`)}